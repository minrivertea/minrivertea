{% extends "base.html" %}
{% load django_static thumbnail %}

{% block pagetitle %}Order (Step 2 of 3) - Confirm Order{% endblock %}

{% block extrajs %}
<script type="text/javascript">

$("#wishlist-link").click(function() {	
	$.getJSON("/order/make_wishlist/", {xhr: "true", order: {{ order.id }}},
  		function(data) {
  		$('#loading').toggle();
  		$(data).appendTo('#wishlist-full');
  		$('#wishlist-link').unbind('click');
  		$('a#wishlist-link').fancybox();
  	});    	
});


$(document).ready( function() {
	$('a#wishlist-link').fancybox();
});

</script>

<script type="application/javascript" src="{% staticfile '/js/lightbox/jquery.fancybox-1.3.4.pack.js' %}"></script>
{% endblock %}

{% block extracss %}
<link rel="stylesheet" href="{% staticfile '/css/fancybox/jquery.fancybox-1.3.4.css' %}" />
<style type="text/css">
div#main-text-wide {
  margin-top: 30px;	
}

div#main-text-wide div#left {
  margin: 30px 0 0 20px;
  width: 550px;	
}


div#main-text-wide div#left h2 {
    font-weight: normal;
}

div.row {
  background-image: none;	
  -moz-box-shadow: none;
}

.paypal {
  margin-bottom: 20px;	
}

#wishlist {
    float: right;
    font-size: 13px;
    font-weight: bold;
    margin: 5px 30px;
    text-align: right;
    width: 300px;
}

#wishlist img {
  position: relative;
  top: 9px;	
  right: -4px;
}

#main-text-wide #wishlist-full {
  display: none;
  float: left;
  width: 500px;
  height: auto;
  position: relative;	
}

#wishlist-full img#loading {
  position: relative;
  left: 230px;	
  top: 135px;
}

#wishlist-full p.url {
  background-color: #f1f1f1;
  padding: 10px 15px;	
}

#wishlist-full strong {
  color: #333;	
}

</style>

{% endblock %}

{% block content %}


<div id="main-text-wide">
  <div class="super">
	<ul id="steps">
		<li class="selected">
			<a href="{% url order_step_one %}">1. Your details</a>
		</li>
		<li class="selected">
			<a href="{% url order_confirm %}">2. Confirm and pay</a>
		</li>
		<li>
			3. Get your tea!
		</li>
	</ul>
	
	<div id="basket">
		
    <form method="post" action="{{ paypal_submit_url }}">
    
    	<div id="checkout-button">
			<img src="{% staticfile '/images/002.gif' %}" class="paypal">
			<input type="submit" value="Confirm and pay" next="" class="button"/>
			<p class="checkout"><strong>Next step:</strong> <em>pay securely via PayPal, using all major credit and debit cards or your linked Paypal account.</em></p>
			
		</div>	
    

		<input type="hidden" name="cmd" value="_cart"> 
		<input type="hidden" name="upload" value="1"> 
		<input type="hidden" name="business" value="{{ paypal_receiver_email }}">
		<input type="hidden" name="currency_code" value="GBP">
		<input type="hidden" name="address_override" value="1">
		
		<input type="hidden" name="address1" value="{{ order.address.house_name_number }}, {{ order.address.address_line_1 }}">		
		<input type="hidden" name="address2" value="{{ order.address.address_line_2 }}">
		<input type="hidden" name="city" value="{{ order.address.town_city }}">
		<input type="hidden" name="country" value="GB">
		<input type="hidden" name="zip" value="{{ order.address.postcode }}">
		<input TYPE="hidden" NAME="return" value="{{ paypal_return_url }}">
		<input TYPE="hidden" NAME="cancel" value="{{ paypal_notify_url }}">
		<input TYPE="hidden" NAME="notify_url" value="{{ paypal_notify_url }}">
		<input type="hidden" id="id_no_shipping" value="1" name="no_shipping">
		<input type="hidden" id="id_charset" value="utf-8" name="charset">

		<input type="hidden" name="invoice" value="TEA-00{{ order.id }}" id="id_invoice" />
		
		{% if order.discount %}
		<input TYPE="hidden" NAME="discount_amount_cart" value="{{ value|floatformat:'2' }}">
		{% endif %}
		

		{% if postage_discount %}
		{% else %}
		<input type="hidden" name="item_name_1" value="Postage Standard Rate"> 
		<input type="hidden" name="quantity_1" value="1">
		<input type="hidden" name="amount_1" value="3.00">
		{% endif %}
		 
		 {% if postage_discount %}
	 		 {% for thing in order.items.all %}
				<input type="hidden" name="item_name_{{ forloop.counter }}" value="{{ thing.item.parent_product.name }} {{ thing.item.parent_product.category }} -  ({{ thing.item.weight|floatformat }}{{ thing.item.weight_unit }})"> 
				<input type="hidden" name="quantity_{{ forloop.counter }}" value="{{ thing.quantity }}">
				<input type="hidden" name="amount_{{ forloop.counter }}" value="{{ thing.item.price }}"> 
			 {% endfor %}
		{% else %}
			 {% for thing in order.items.all %}
				<input type="hidden" name="item_name_{{ forloop.counter|add:"1" }}" value="{{ thing.item.parent_product.name }} {{ thing.item.parent_product.category }} -  ({{ thing.item.weight|floatformat }}{{ thing.item.weight_unit }})"> 
				<input type="hidden" name="quantity_{{ forloop.counter|add:"1" }}" value="{{ thing.quantity }}">
				<input type="hidden" name="amount_{{ forloop.counter|add:"1" }}" value="{{ thing.item.price }}"> 
			 {% endfor %}
		{% endif %}
		
		<div class="row">
			<div class="row-label">
				<h2>You're ordering...</h2>
			</div>
			
			<div class="row-box">
				<table>
				{% for thing in order.items.all %}
				  <tr>				
			    	<td width="110px" valign="top">
			    		{% thumbnail thing.item.parent_product.image "100" as im %}
			    			<img src="{{ im.url }}"/>
			    		{% endthumbnail %}
			    	</td>
			    	<td width="250px">
			    		{{ thing.quantity }} X {{ thing.item.parent_product.name }} ({% if not thing.item.weight %}
			    		{% else %}{{ thing.item.weight|floatformat }}{{ thing.item.weight_unit }}{% endif %})
			    	</td>
			    	<td width="150px" valign="top">
			    	</td>
			    	<td>£{{ thing.get_price }}</td>		    				
				  </tr>
			    {% endfor %}
			  {% if postage_discount %}
			  <tr>
			    <td><span class="small"><em>There is no postage charge, because your order is over £50</em></span></td>
			  </tr>
			  {% else %}
			  <tr>
			  	<td>&nbsp;</td>
			  	<td>Postage</td>
			  	<td>&nbsp;</td>
			  	<td>£3.00</td>		  
			  </tr>
		  	  {% endif %}
		  	  {% if order.discount %}
			  <tr>
			  	<td>&nbsp;</td>
			  	<td>Discount</td>
			  	<td>&nbsp;</td>
			  	<td>-£{{ value|floatformat:"2" }}</td>
			  </tr>
			  {% endif %}
			  <tr>
			  	<td>&nbsp;</td>
			  	<td><strong>TOTAL</strong></td>
			  	<td>&nbsp;</td>
			  	<td><strong>£{{ total_price|floatformat:"2" }}</strong></td>		  
			  </tr>
			</table>
		</div>
	</div>



	<div class="row">
		<div class="row-label">
			<h2>…and we'll send your order to:</h2>
		</div>
		
		<div class="row-box">
		    {{ order.owner.first_name }} {{ order.owner.last_name }}<br/>
			{{ order.address.house_name_number }}<br/>
			{{ order.address.address_line_1 }}<br/>
			{{ order.address.address_line_2 }}<br/>
			{{ order.address.town_city }}<br/>
			{{ order.address.postcode }}<br/>
			{{ order.address.country|upper }}
		</div>
	</div>

	</form> 


</div>


<div id="wishlist">
	<a id="wishlist-link" href="#wishlist-full">Turn this basket into a wishlist! <img src="{% staticfile '/images/gift_small.png' %}"></a>
	<div id="wishlist-full" style="width: 550px; height: 300px; padding: 30px;">
		<img id="loading" src="{% staticfile '/images/loading.gif' %}"/>
	</div>
</div>
	
<div id="left">
	<h2>Problems or questions?</h2>
    <p>We aim to offer first class customer service - if you have ANY problems or questions, contact Chris West, the owner, directly on email at <a href="mailto:chris@minrivertea.com">chris@minrivertea.com</a> - I'll respond normally within a few hours to every email.</p>

</div>

</div>

	
	
	
  </div>
</div>
{% endblock %}
